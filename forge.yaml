name: forge

# -- artifactStorePath is the path to the unified artifact store (moved to root level)
artifactStorePath: .forge/artifact-store.yaml

# -- localContainerRegistry configuration (root level defaults)
localContainerRegistry:
  enabled: false  # Disabled by default, enabled via testenv spec
  namespace: testenv-lcr
  credentialPath: .forge/registry-credentials.yaml
  caCrtPath: .forge/ca.crt

# -- engines defines custom engine configurations with aliases
engines:
  # Example: custom test runner alias
  # - alias: verify-tags-runner
  #   type: test-runner
  #   testRunner:
  #     - engine: go://generic-test-runner
  #       spec:
  #         command: "go"
  #         args: ["run", "./cmd/go-lint-tags", "."]

  - alias: setup-integration
    type: testenv
    testenv:
      - engine: "go://testenv-kind"
      # spec:
      #   kubeconfigPath: .ignore.kindenv.kubeconfig.yaml

      - # -- localContainerRegistry will create if enabled a container registry in the kindenv using the kubeconfig which path
        #    is defined by {.kindenv.kubeconfigPath}.
        engine: "go://testenv-lcr"
        spec:
          # -- autoPushImages defines whether to automatically push images from artifact store on setup.
          autoPushImages: true
          # -- enabled defines whether the local container registry must be created or not.
          enabled: true
          # -- creadentialPath defines the output file containing the container registry credentials.
          # credentialPath: .ignore.local-container-registry.yaml
          # -- path to CA certificate.
          # caCrtPath: .ignore.ca.crt
          # -- namespace where the local container registry will be deployed.
          # namespace: local-container-registry
          # -- imagePullSecretNamespaces is a list of namespaces where image pull secrets should be automatically created.
          imagePullSecretNamespaces:
            - default
            - test-podinfo
            # -- imagePullSecretName is the name of the image pull secret to create (defaults to "local-container-registry-credentials").
            # imagePullSecretName: local-container-registry-credentials

      - # -- testenv-helm-install installs Helm charts into the Kind cluster
        engine: "go://testenv-helm-install"
        spec:
          charts:
            # Using a lightweight chart that actually exists
            - name: podinfo/podinfo
              repo: https://stefanprodan.github.io/podinfo
              namespace: test-podinfo
              releaseName: test-podinfo

# -- test defines the test stages and their configuration
test:
  # -- verify-tags - verify all test files have build tags
  - name: verify-tags
    runner: "go://go-lint-tags"
    # -- default value for setup is "go://test-report"

  # -- lint - linting as a test stage (no environment needed)
  - name: lint
    runner: "go://go-lint"

  # -- unit tests - no environment management needed
  - name: unit
    runner: "go://go-test"

  # -- integration tests - creates isolated test environments
  - name: integration
    runner: "go://go-test"
    testenv: "alias://setup-integration"

  # -- e2e tests - comprehensive forge integration tests (no environment needed)
  - name: e2e
    runner: "go://forge-e2e"

# -- build defines the artifacts to build
build:
  # Format code before building
  - name: format-code
    src: .
    engine: go://go-format

  # Binaries
  - name: forge
    src: ./cmd/forge
    dest: ./build/bin
    engine: go://go-build
  - name: go-build
    src: ./cmd/go-build
    dest: ./build/bin
    engine: go://go-build
  - name: container-build
    src: ./cmd/container-build
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-kind
    src: ./cmd/testenv-kind
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-lcr
    src: ./cmd/testenv-lcr
    dest: ./build/bin
    engine: go://go-build
  - name: testenv-helm-install
    src: ./cmd/testenv-helm-install
    dest: ./build/bin
    engine: go://go-build
  - name: go-test
    src: ./cmd/go-test
    dest: ./build/bin
    engine: go://go-build
  - name: go-lint-tags
    src: ./cmd/go-lint-tags
    dest: ./build/bin
    engine: go://go-build
  - name: testenv
    src: ./cmd/testenv
    dest: ./build/bin
    engine: go://go-build
  - name: go-format
    src: ./cmd/go-format
    dest: ./build/bin
    engine: go://go-build
  - name: go-lint
    src: ./cmd/go-lint
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-mocks
    src: ./cmd/go-gen-mocks
    dest: ./build/bin
    engine: go://go-build
  - name: go-gen-openapi
    src: ./cmd/go-gen-openapi
    dest: ./build/bin
    engine: go://go-build
  - name: forge-e2e
    src: ./cmd/forge-e2e
    dest: ./build/bin
    engine: go://go-build
  - name: generic-builder
    src: ./cmd/generic-builder
    dest: ./build/bin
    engine: go://go-build
  - name: generic-test-runner
    src: ./cmd/generic-test-runner
    dest: ./build/bin
    engine: go://go-build
  - name: test-report
    src: ./cmd/test-report
    dest: ./build/bin
    engine: go://go-build
  - name: ci-orchestrator
    src: ./cmd/ci-orchestrator
    dest: ./build/bin
    engine: go://go-build

  # Containers
  - name: for-testing-purposes
    src: ./containers/for-testing-purposes/Containerfile
    engine: go://container-build

# -- generateOpenAPI defines the configuration for generating OpenAPI client and server code
# generateOpenAPI:
#   defaults:
#     sourceDir: ./api
#     destinationDir: ./pkg/generated
#     engine: go://go-gen-openapi
#   specs:
#     - name: example-api
#       versions:
#         - v1
#       client:
#         enabled: true
#         packageName: exampleclient
#       server:
#         enabled: true
#         packageName: exampleserver

